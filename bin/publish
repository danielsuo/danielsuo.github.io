#!/usr/bin/env bash

usage() {
  echo "Usage: $0 [-m COMMIT_MESSAGE]" 1>&2; exit 1;
}

publish() {
  cp ~/.config/nvim/init.vim dotfiles/vimrc.txt
  cp ~/.tmux.conf dotfiles/tmux.conf
  cp ~/.gitconfig dotfiles/gitconfig.txt
  cp ~/.profile dotfiles/profile.txt
  cp ~/.bashrc dotfiles/bashrc.txt

  if [ -f ../cv/cv.pdf ]; then
    cp ../cv/cv.pdf cv.pdf
    git add -f cv.pdf
  fi

  git fetch origin master:master
  git pull origin dev

  ./bin/indexify notes
  ./bin/markdownify

  git add .
  git commit -m "$1"
  git push origin dev

  rm -rf _site && mkdir _site
  cp -R .git _site
  cd _site
  git checkout master
  git pull origin master
  cd ../
  jekyll build
  cd _site
  git add .

  # Forced file adds
  git add -f cv.pdf

  git commit -m "$1"
  git push origin master

  cd ../
}

while getopts "m:" opt; do
  case $opt in
    m)
      m=$OPTARG
      publish "$m"
      ;;
    *)
      usage
      ;;
  esac
done

shift $((OPTIND-1))
if [ -z "$m" ]; then
    usage
fi
